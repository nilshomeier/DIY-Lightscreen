<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightscreen</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
        }
        table, td {
            text-align: center; 
            vertical-align: middle;
        }
        td {
            padding-top: 0px; 
            padding-bottom: 10px; 
            padding-left: 20px; 
            padding-right: 20px; 
        }
        table, td {
            text-align: center; 
            vertical-align: middle;
        }
        td {
            padding-top: 0px; 
            padding-bottom: 10px; 
            padding-left: 20px; 
            padding-right: 20px; 
        }
        /* The switch - the box around the slider */
        .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
        }

        /* Hide default HTML checkbox */
        .switch input {
        opacity: 0;
        width: 0;
        height: 0;
        }

        /* The slider */
        .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        -webkit-transition: .4s;
        transition: .4s;
        }

        .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        top: 4px;
        background-color: white;
        -webkit-transition: .4s;
        transition: .4s;
        }

        input:checked + .slider {
        background-color: #2196F3;
        }

        input:focus + .slider {
        box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
        -webkit-transform: translateX(26px);
        -ms-transform: translateX(26px);
        transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
        border-radius: 34px;
        }

        .slider.round:before {
        border-radius: 50%;
        }
    </style>
</head>

<body onload="getInformation()">
    <center>
        <h1>Lightscreen Einstellungen</h1>
        <div>
            <h2>Lightscreen Power</h2>
            <label class="switch">
                <input type="checkbox" id="switchPower">
                <span class="slider round"></span>
            </label>
            <h2>AutoMode</h2>
            <label class="switch">
                <input type="checkbox" id="switchAutoMode">
                <span class="slider round"></span>
            </label>
        </div>

        <table style="display: inline-block;">
            <!-- <tr>
                <td><h2>Back Panel</h2></td>
                <td><h2>Side Panel</h2></td>
            </tr>
            <tr>
                <td>
                    <label class="switch">
                        <input type="checkbox" id="switchBack">
                        <span class="slider round"></span>
                    </label>
                </td>
                <td>
                    <label class="switch">
                        <input type="checkbox" id="switchSide">
                        <span class="slider round"></span>
                    </label>
                </td>
            </tr> -->
            <tr>
                <td colspan="2"><h2>Helligkeit einstellen:</h2></td>
            </tr>
            <!-- <tr>
                <td colspan="2">Helligkeit</td>
                <td>max. Helligkeit</td>
            </tr> -->
            <!-- <tr>
                <td colspan="2">
                    <div class="slidecontainer">
                        <label for="brightnessT">Helligkeit oben</label>
                        <input type="range" min="1" max="255" value="255" class="bar" id="brightnessT">
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <div class="slidecontainer">
                        <label for="brightnessB">Helligkeit unten</label>
                        <input type="range" min="1" max="255" value="255" class="bar" id="brightnessB">
                    </div>
                </td>
            </tr> -->
            <tr>
                <td colspan="2">
                    <div class="slidecontainer">
                        <label for="setBrightness">Helligkeit</label>
                        <input type="range" min="0" max="255" value="128" class="bar" id="setBrightness">
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <div class="slidecontainer">
                        <label for="maxBrightness">max. Helligkeit</label>
                        <input type="range" min="1" max="255" value="255" class="bar" id="maxBrightness" >
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="2"><h2>Farben:</h2></td>
                <!-- <td><h2>Farbe B:</h2></td> -->
            </tr>
            <tr>
                <td>
                    <div>
                        <label for="colorpickerTA">oben links:</label>
                        <input type="color" id="colorpickerTA" value="#0000ff">
                    </div>
                </td>   
                <td>
                    <div>
                        <label for="colorpickerTB">oben rechts:</label>
                        <input type="color" id="colorpickerTB" value="#0000ff">
                    </div>
                </td>   
            </tr>
            <tr>
                <td>
                    <div>
                        <label for="colorpickerBA">unten links:</label>
                        <input type="color" id="colorpickerBA" value="#0000ff">
                    </div>
                </td>   
                <td>
                    <div>
                        <label for="colorpickerBB">unten rechts:</label>
                        <input type="color" id="colorpickerBB" value="#0000ff">
                    </div>
                </td>   
            </tr>
            <tr>
                <td colspan="2"><h2>Zeit einstellen:</h2></td>
            </tr>
            <tr>
                <td colspan="2">
                    <div>
                        <label for="timeUp">Lightscreen an:</label>
                        <input type="time" id="timeUp" name="timeUp">
                    </div>
                </td>  
            </tr>
            <tr>
                <td colspan="2">
                    <div>
                        <label for="timeDown">Lightscreen aus:</label>
                        <input type="time" id="timeDown" name="timeDown">
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <div>
                        <label for="fadeTime">Fadetime:</label>
                        <input type="text" id="fadeTime" name="fadeTime">
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="2"><button onclick="save()">Speichern</button></td>
            </tr>
        </table>

    </center>
</body>

<script>
    function padLeadingZeros(num, size) {
        var s = num + "";
        while (s.length < size) s = "0" + s;
        return s;
    }

    function getInformation(){
        var url = "/getInformation"
        var xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var responseJson = JSON.parse(xhr.response.replace('"ledStrips":',''));
                console.log(responseJson);

                document.getElementById("switchPower").checked = responseJson[0].power;
                document.getElementById("switchAutoMode").checked = responseJson[0].autoMode;

                document.getElementById("maxBrightness").setAttribute("value", responseJson[0].maxBrightness);
                document.getElementById("setBrightness").setAttribute("value", responseJson[0].maxBrightness);

                document.getElementById("timeUp").setAttribute("value", padLeadingZeros(responseJson[0].upTimeHour, 2) + ":" + padLeadingZeros(responseJson[0].upTimeMinute, 2));
                document.getElementById("timeDown").setAttribute("value", padLeadingZeros(responseJson[0].downTimeHour, 2) + ":" +  padLeadingZeros(responseJson[0].downTimeMinute, 2));

                document.getElementById("fadeTime").setAttribute("value", (responseJson[0].fadeTime / 600))

                document.getElementById("colorpickerTA").setAttribute("value", rgbToHex(responseJson[0].colorTopLeft[0], responseJson[0].colorTopLeft[1], responseJson[0].colorTopLeft[2]));
                document.getElementById("colorpickerTB").setAttribute("value", rgbToHex(responseJson[0].colorTopRight[0], responseJson[0].colorTopRight[1], responseJson[0].colorTopRight[2]));
                document.getElementById("colorpickerBA").setAttribute("value", rgbToHex(responseJson[0].colorBottomLeft[0], responseJson[0].colorBottomLeft[1], responseJson[0].colorBottomLeft[2]));
                document.getElementById("colorpickerBB").setAttribute("value", rgbToHex(responseJson[0].colorBottomRight[0], responseJson[0].colorBottomRight[1], responseJson[0].colorBottomRight[2]));

            }
        };

        xhr.open("GET", url);
        xhr.setRequestHeader("Accept", "*/*");
        xhr.send();
        
    }

    function rgbToHex(r, g, b) {
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }

    function hexToRgb(hex) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }

    // document.getElementById("switchBack").addEventListener("click", function() {
    //     console.log("back: " + document.getElementById("switchBack").checked);
    //     var url = "";
    //     if(document.getElementById("switchBack").checked){
    //         url = "/on?strip=Back";
    //     }else{
    //         url = "/off?strip=Back"
    //     }
    //     var xhr = new XMLHttpRequest();

    //     xhr.open("GET", url);
    //     xhr.setRequestHeader("Accept", "*/*");
    //     xhr.send();
    // });

    // document.getElementById("switchSide").addEventListener("click", function() {
    //     console.log("side: " + document.getElementById("switchSide").checked);
    //     var url = "";
    //     if(document.getElementById("switchSide").checked){
    //         url = "/on?strip=Side";
    //     }else{
    //         url = "/off?strip=Side"
    //     }
    //     var xhr = new XMLHttpRequest();

    //     xhr.open("GET", url);
    //     xhr.setRequestHeader("Accept", "*/*");
    //     xhr.send();
    // });

    document.getElementById("switchPower").addEventListener("change", function() {
        var url = "";
        if(document.getElementById("switchPower").checked){
            url = "/on";
        }else{
            url = "/off";
        }
        var xhr = new XMLHttpRequest();

        xhr.open("GET", url);
        xhr.setRequestHeader("Accept", "*/*");
        xhr.send();
    });

    document.getElementById("switchAutoMode").addEventListener("change", function() {
        var url = "/activateAutoMode";
    
        var xhr = new XMLHttpRequest();

        xhr.open("GET", url);
        xhr.setRequestHeader("Accept", "*/*");
        xhr.send();
    });

    // function saveBrightness() {
    //     var brightnessMax = document.getElementById("maxBrightness").value
    //     var brightnessSet = document.getElementById("setBrightness").value
    //     var url = "/stripBrightness?mb=" + brightnessMax + "&sb=" + brightnessSet;
    //     console.log(url);
    //     var xhr = new XMLHttpRequest();

    //     xhr.onreadystatechange = function(){
    //         if (this.readyState == 4 && this.status == 200) {
    //             saveColor();
    //             saveTime();
    //         };
    //     };
        
    //     xhr.open("GET", url);
    //     xhr.setRequestHeader("Accept", "*/*");
    //     xhr.send();
    // }

    // function saveColor() {
    //     var colorTA = hexToRgb(document.getElementById("colorpickerTA").value)
    //     var colorTB = hexToRgb(document.getElementById("colorpickerTB").value)
    //     var colorBA = hexToRgb(document.getElementById("colorpickerBA").value)
    //     var colorBB = hexToRgb(document.getElementById("colorpickerBB").value)
        
    //     console.log("colorpickerTA: (" + colorTA.r + "," + colorTA.g + "," + colorTA.b + ")");
    //     console.log("colorpickerTB: (" + colorTB.r + "," + colorTB.g + "," + colorTB.b + ")");
    //     console.log("colorpickerBA: (" + colorBA.r + "," + colorBA.g + "," + colorBA.b + ")");
    //     console.log("colorpickerBB: (" + colorBB.r + "," + colorBB.g + "," + colorBB.b + ")");


    //     var url = "/setColor?TA=(" + padLeadingZeros(colorTA.r, 3) + "," + padLeadingZeros(colorTA.g, 3) + "," + padLeadingZeros(colorTA.b, 3) + ")" + "&TB=(" + padLeadingZeros(colorTB.r, 3) + "," + padLeadingZeros(colorTB.g, 3) + "," + padLeadingZeros(colorTB.b, 3) + ")" + "&BA=(" + padLeadingZeros(colorBA.r, 3) + "," + padLeadingZeros(colorBA.g, 3) + "," + padLeadingZeros(colorBA.b, 3) + ")" + "&BB=(" + padLeadingZeros(colorBB.r, 3) + "," + padLeadingZeros(colorBB.g, 3) + "," + padLeadingZeros(colorBB.b, 3) + ")";
    //     var xhr = new XMLHttpRequest();
    //     console.log(url);

    //     xhr.onreadystatechange = function(){
    //         console.log(xhr.response);
    //     };
        
    //     response = xhr.open("GET", url);
    //     xhr.setRequestHeader("Accept", "*/*");
    //     xhr.send();
    // }

    // function saveTime(){
    //     var upTime = document.getElementById("timeUp").value;
    //     var upTimeSplit = upTime.split(":");
    //     var upTimeSec = upTimeSplit[0]*3600 + upTimeSplit[1]*60;
    //     var downTime = document.getElementById("timeDown").value;
    //     var downTimeSplit = downTime.split(":");
    //     var downTimeSec = downTimeSplit[0]*3600 + downTimeSplit[1]*60;

    //     var url = "/setFadeTime?upTimeHour=" + upTimeSplit[0] + "&upTimeMin=" + upTimeSplit[1] + "&downTimeHour=" + downTimeSplit[0] + "&downTimeMin=" + downTimeSplit[1];
    //     var xhr = new XMLHttpRequest();

    //     xhr.onreadystatechange = function(){
    //         console.log(xhr.response);

    //     };
        
    //     xhr.open("GET", url);
    //     xhr.setRequestHeader("Accept", "*/*");
    //     xhr.send();
    // }

    function save(){
        var upTime = document.getElementById("timeUp").value;
        var upTimeSplit = upTime.split(":");
        var upTimeSec = upTimeSplit[0]*3600 + upTimeSplit[1]*60;
        var downTime = document.getElementById("timeDown").value;
        var downTimeSplit = downTime.split(":");
        var downTimeSec = downTimeSplit[0]*3600 + downTimeSplit[1]*60;
        var fadeTime = document.getElementById("fadeTime").value * 600;

        var url = "/saveConfig?upTimeHour=" + upTimeSplit[0] + "&upTimeMin=" + upTimeSplit[1] + "&downTimeHour=" + downTimeSplit[0] + "&downTimeMin=" + downTimeSplit[1] + "&fadeTime=" + fadeTime;

        var colorTA = hexToRgb(document.getElementById("colorpickerTA").value)
        var colorTB = hexToRgb(document.getElementById("colorpickerTB").value)
        var colorBA = hexToRgb(document.getElementById("colorpickerBA").value)
        var colorBB = hexToRgb(document.getElementById("colorpickerBB").value)
        
        url = url + "&TA=(" + padLeadingZeros(colorTA.r, 3) + "," + padLeadingZeros(colorTA.g, 3) + "," + padLeadingZeros(colorTA.b, 3) + ")" + "&TB=(" + padLeadingZeros(colorTB.r, 3) + "," + padLeadingZeros(colorTB.g, 3) + "," + padLeadingZeros(colorTB.b, 3) + ")" + "&BA=(" + padLeadingZeros(colorBA.r, 3) + "," + padLeadingZeros(colorBA.g, 3) + "," + padLeadingZeros(colorBA.b, 3) + ")" + "&BB=(" + padLeadingZeros(colorBB.r, 3) + "," + padLeadingZeros(colorBB.g, 3) + "," + padLeadingZeros(colorBB.b, 3) + ")";

        var brightnessMax = document.getElementById("maxBrightness").value
        var brightnessSet = document.getElementById("setBrightness").value
        url = url + "&mb=" + brightnessMax + "&sb=" + brightnessSet;

        var xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function(){
            console.log(xhr.response);

        };
        
        xhr.open("GET", url);
        xhr.setRequestHeader("Accept", "*/*");
        xhr.send();

    }

    function hexToHSL(H) {
        // Convert hex to RGB first
        let r = 0, g = 0, b = 0;
        if (H.length == 4) {
            r = "0x" + H[1] + H[1];
            g = "0x" + H[2] + H[2];
            b = "0x" + H[3] + H[3];
        } else if (H.length == 7) {
            r = "0x" + H[1] + H[2];
            g = "0x" + H[3] + H[4];
            b = "0x" + H[5] + H[6];
        }
        // Then to HSL
        r /= 255;
        g /= 255;
        b /= 255;
        console.log("r: " + r);
        console.log("g: " + g);
        console.log("b: " + b);
        let cmin = Math.min(r,g,b),
            cmax = Math.max(r,g,b),
            delta = cmax - cmin,
            h = 0,
            s = 0,
            l = 0;

        if (delta == 0)
            h = 0;
        else if (cmax == r)
            h = ((g - b) / delta) % 6;
        else if (cmax == g)
            h = (b - r) / delta + 2;
        else
            h = (r - g) / delta + 4;

        h = Math.round(h * 60);

        if (h < 0)
            h += 360;

        l = (cmax + cmin) / 2;
        s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
        l = +(l * 100).toFixed(1);

        return [h*255/360, s*255];
    }

    /**
     * Converts an HSL color value to RGB. Conversion formula
     * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
     * Assumes h, s, and l are contained in the set [0, 1] and
     * returns r, g, and b in the set [0, 255].
     *
     * @param   Number  h       The hue
     * @param   Number  s       The saturation
     * @param   Number  l       The lightness
     * @return  Array           The RGB representation
     */
    function hslToRgb(h, s, l) {
        h /= 255;
        s /= 255;
        l /= 255;
        var r, g, b;

        if (s == 0) {
            r = g = b = l; // achromatic
        } else {
            function hue2rgb(p, q, t) {
                if (t < 0) t += 1;
                if (t > 1) t -= 1;
                if (t < 1/6) return p + (q - p) * 6 * t;
                if (t < 1/2) return q;
                if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                return p;
            }

            var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
            var p = 2 * l - q;

            r = hue2rgb(p, q, h + 1/3);
            g = hue2rgb(p, q, h);
            b = hue2rgb(p, q, h - 1/3);
        }

        return [ r * 255, g * 255, b * 255 ];
    }

    function hslToHEX(h, s, l) {
        h /= 255;
        s /= 255;
        l /= 255;
        var r, g, b;

        if (s == 0) {
            r = g = b = l; // achromatic
        } else {
            function hue2rgb(p, q, t) {
                if (t < 0) t += 1;
                if (t > 1) t -= 1;
                if (t < 1/6) return p + (q - p) * 6 * t;
                if (t < 1/2) return q;
                if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                return p;
            }

            var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
            var p = 2 * l - q;

            r = hue2rgb(p, q, h + 1/3);
            g = hue2rgb(p, q, h);
            b = hue2rgb(p, q, h - 1/3);
        }

        // return [ r * 255, g * 255, b * 255 ];
        r *= 255;
        g *= 255;
        b *= 255;
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }
    </script>
</html>